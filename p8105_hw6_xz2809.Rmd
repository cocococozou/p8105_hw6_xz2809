---
title: "P8105_hw6_xz2809"
author: "Coco"
date: "11/24/2018"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(modelr)
library(mgcv)
set.seed(1)
```

##Problem 1

Here is the **code chunk** to read csv file and conduct the data wrangling

```{r  message=FALSE, warning=FALSE}
homicide_df <- read_csv(file = "./data/homicide-data.csv") %>% 
  janitor::clean_names() %>% 
  mutate(city_state = paste(city,state,sep=", "),
         resolved = case_when(disposition == "Closed by arrest"~1,
                              TRUE ~ 0),
         victim_age = as.numeric(victim_age)) %>% 
  filter(!(city_state %in% c("Dallas, TX","Phoenix, AZ","Kansas City, MO", "Tulsa, AL"))) %>% 
  mutate(victim_race_modified = case_when(victim_race == "White"~"white",
                                          TRUE~"non_white"),
         victim_race = as.factor(victim_race_modified))%>% 
  select(-victim_race_modified) %>% 
  within(victim_race <- relevel(victim_race, ref = "white"))
  
```

For the city of Baltimore, MD, use the glm function to fit a logistic regression with resolved vs unresolved as the outcome and victim age, sex and race (as just defined) as predictors. Save the output of glm as an R object; apply the broom::tidy to this object; and obtain the estimate and confidence interval of the adjusted odds ratio for solving homicides comparing non-white victims to white victims keeping all other variables fixed.

```{r  message=FALSE, warning=FALSE}
baltimore_df = 
  homicide_df %>% 
  filter(city == "Baltimore")

fit_logistic = 
  baltimore_df %>% 
  glm(resolved ~ victim_age + victim_race + victim_sex, data = ., family = binomial()) 

fit_logistic %>% 
  broom::tidy() %>% 
  mutate(OR = exp(estimate)) %>%
  select(term, log_OR = estimate, OR) %>% 
  filter((term %in% c("victim_racenon_white"))) %>% 
  knitr::kable(digits = 3)

confint(fit_logistic,level=0.95)
                         
```

Now run glm for each of the cities in your dataset, and extract the adjusted odds ratio (and CI) for solving homicides comparing non-white victims to white victims. Do this within a “tidy” pipeline, making use of purrr::map, list columns, and unnest as necessary to create a dataframe with estimated ORs and CIs for each city.
```{r  message=FALSE, warning=FALSE}
homicide_df_model = homicide_df %>% 
  select(victim_age,victim_sex,victim_race,resolved,city_state) %>% 
  group_by(city_state) %>% 
  nest() %>% 
  mutate(models = map(data, ~glm(resolved ~ victim_age + victim_sex+victim_race, data = .x, family = binomial())),
         ci = map(models,confint),
         ci = map(ci,broom::tidy),
         models = map(models, broom::tidy)) %>% 
  select(-data) %>% 
  unnest() %>% 
  filter((term %in% c("victim_racenon_white"))) %>% 
  mutate(OR = exp(estimate),
         low_bond = exp(X2.5..),
         high_bond = exp(X97.5..)) %>% 
  select(city_state,low_bond,high_bond,OR)
```

Create a plot that shows the estimated ORs and CIs for each city. Organize cities according to estimated OR, and comment on the plot.
```{r  message=FALSE, warning=FALSE}
homicide_df_model %>% 
  ggplot()+
  geom_point(aes(reorder(city_state,OR), y = OR))+
  geom_errorbar(aes(x=city_state, ymin = low_bond, ymax = high_bond))+
  theme(axis.text.x = element_text(angle = 90, hjust = 1))+
  labs(
    title = "Cities vs Estimated ORs with 95% CI",
    x = "Cities",
    y = "Estimated ORs"
  )
```

##Problem 2

Here is the **code chunk** to read the csv file and conduct the data wrangling

```{r}
rm(list=ls(all=TRUE))

birthweight_df = read_csv(file = "./data/birthweight.csv") %>% 
  na.omit() %>% 
  mutate(babysex = as.factor(babysex),
         frace = as.factor(frace),
         mrace = as.factor(mrace),
         malform = as.factor(malform))
```



```{r}
cv_df = 
  crossv_mc(birthweight_df, 100) %>% 
  mutate(train = map(train, as_tibble),
         test = map(test, as_tibble))

myfit =  lm(bwt ~ ppbmi + wtgain, data = birthweight_df)

birthweight_df %>% 
  add_predictions(myfit) %>% 
  add_residuals(myfit) %>% 
  ggplot(aes(x = pred, y = resid)) + geom_point() 

ggplot(birthweight_df, aes(x = gaweeks, y = bwt)) + geom_point() + theme_bw()

```

Compare your model to two others:

One using length at birth and gestational age as predictors (main effects only)
One using head circumference, length, sex, and all interactions (including the three-way interaction) between these

```{r}
cv_df = 
  cv_df %>% 
  mutate(my_mod    = map(train, ~lm(bwt ~ ppbmi + wtgain, data = .x)),
         given1_mod = map(train, ~lm(bwt ~ blength + gaweeks, data = .x)),
         given2_mod = map(train, ~lm(bwt ~ bhead + blength + babysex + bhead*blength + bhead*babysex + babysex*bhead + bhead*blength*babysex, data = .x))) %>% 
  mutate(rmse_my    = map2_dbl(my_mod, test, ~rmse(model = .x, data = .y)),
         rmse_given1 = map2_dbl(given1_mod, test, ~rmse(model = .x, data = .y)),
         rmse_given2 = map2_dbl(given2_mod, test, ~rmse(model = .x, data = .y)))

cv_df %>% 
  select(starts_with("rmse")) %>% 
  gather(key = model, value = rmse) %>% 
  mutate(model = str_replace(model, "rmse_", ""),
         model = fct_inorder(model)) %>% 
  ggplot(aes(x = model, y = rmse)) + geom_violin()
```




 

